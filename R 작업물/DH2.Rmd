---
  title: "삶의 만족도와 지역 만족도에 영향있는 지역시설_2차"
author: "김동현"
date: '2022 11 23 '
output: html_document
---
  
# 1. 데이터 준비
  
  
  - 기존의 5가지 독립변수들을 제외한 다른 추가 변수 탐색
- 추가된 변수들은 '버스정거장수','지하철역수', '인구수', '아파트수', '파출소수', '체육시설수', '범죄건수'이다. 

```{r}
secondary <- read.csv("../data/secondary.csv", head = TRUE)
secondary <- secondary[, -c(1)]
str(secondary)
```






# 2. 상관분석


- 종속변수(삶만족도, 지역만족도)와 추가된 변수들간의 상관관계 확인


```{r}
# 시각화1
# install.packages('PerformanceAnalytics')
library(PerformanceAnalytics)
chart.Correlation(secondary[ ,c(2,3,9:15) ])

```

```{r}
# 시각화2
# install.packages('corrgram')
library(corrgram)
corrgram(secondary[ ,c(2,3,9:15) ],lower.panel = panel.conf)

```

#### 삶의 만족도와 다른 변수들 간의 상관분석 결과
- 버스정거장 수와 삶의 만족도는 상관계수 -0.01로 상관관계가 있다고 볼 수 없다.
- 지하철 역 수와 삶의 만족도는 상관계수 0.35로 약한 양의 상관관계가 있다고 볼 수 있다.
- 인구 수와 삶의 만족도는 상관계수 -0.17로 아주 약한 음의 상관관계가 있다고 볼 수 있다.
- 아파트 수와 삶의 만족도는 상관계수 -0.24로 약한 음의 상관관계가 있다고 볼 수 있다.
- 파출소 수와 삶의 만족도는 상관계수 0.35로 약한 양의 상관관계가 있다고 볼 수 있다.
- 체육시설 수와 삶의 만족도는상관계수 0.01로 상관관계가 있다고 보기 어렵다.
- 범죄건수와 삶의 만족도는상관계수 -0.11로 상관관계가 있다고 보기 어렵다.

#### 지역 만족도와 다른 변수들 간의 상관분석 결과
- 버스정거장 수와 지역 만족도는 상관계수 0.2로 약한 양의 상관관계가 있다고 볼 수 있다.
- 지하철 역 수와 지역 만족도는 상관계수 0.51로 양의 상관관계가 있다고 볼 수 있다.
- 인구 수와 지역 만족도는 상관계수 0으로 상관관계가 있다고 볼 수 없다.
- 아파트 수와 지역 만족도는 상관계수 -0.1로 상관관계가 있다고 볼 수 없다.
- 파출소 수와 지역 만족도는 상관계수 0.42로 양의 상관관계가 있다고 볼 수 있다.
- 체육시설 수와 지역 만족도는상관계수 0.01로 상관관계가 있다고 볼 수 없다.
- 범죄건수와 지역 만족도는상관계수 -0.11로 상관관계가 있다고 볼 수 없다.






# 3. 삶의 만족도에 대한 2차 회귀분석 



## 3-1. 종속변수가 삶의 만족도일 때, 1차 때 고른 독립변수 + 추가 독립변수

- 기존 'class1', '문화시설수'에 '버스정거장수','지하철역수', '인구수', '아파트수', '파출소수', '체육시설수', '범죄건수' 변수 추가

```{r}
fit11 <- lm(삶만족도 ~ class1 + 문화시설수 + 버스정거장수 + 지하철역수 + 인구수 + 아파트수 + 
                  체육시설수 + 범죄건수, data = secondary)

summary(fit11)

```

- 설명력이 -0.015 라는 음수값이 나옴
- 유의확률(p-value)이 0.5로 유의한 모델이라고 볼 수 없다.
- 이상치의 여부를 확인하여 교정할 것.
- 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부를 확인하여 교정할 것.




## 3-2. 종속변수가 삶의 만족도일 때의 2차 단계적 성능 개선


## 3-2-1. 이상치의 여부 확인 및 교정

```{r}
# install.packages("car")
library(car)

par(mfrow=c(1,1))
influencePlot(fit11, id=list(method = "identify")) 

secondary11_1 <- secondary[-c(3, 23, 24),]

str(secondary11_1)
```

- 3, 23, 24 번째 데이터가 이상치임을 확인
- 해당 데이터를 삭제하여 교정

```{r}
fit11_2 <- lm(삶만족도 ~ class1 + 문화시설수 + 버스정거장수 + 인구수 + 지하철역수  + 아파트수 + 
                    체육시설수 + 범죄건수, data = secondary11_1)
summary(fit11_2)


```

- 이상치 제거 후, 설명력(Adjested R-squared) 0.1668 로 증가하여 모델의 성능이 향상됨.
- 유의확률(P-value) 또한 0.2394으로 낮아진 것을 볼 수 있지만 아직까지도 유의한 모델이라고 볼 수 없다. 



## 3-2-2. 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부 확인 및 교정

```{r}
par(mfrow=c(2,2))
plot(fit11_2)


```

- Residuals VS Fitted 그래프의 모양이 패턴이 없는 것으로 보아 선형성은 만족해보임
- Normal Q-Q 그래프의 경우 선에 점들이 모여있는 것으로 보아 정규성 만족해보임
- Scale-Location 그래프의 모양이 패턴이 없는 것으로 보아 등분산성 만족해보임



### 3-2-3. 독립성(다중공선성) 여부 확인 및 교정

```{r}
# install.packages("car")
# library(car)
sqrt(vif(fit11_2))

```

- 지하철역 수와 인구 수, 범죄건수의 VIF값이 2보다 커서 독립성에 문제가 있다고 보인다.


#### 상관계수 확인

```{r}
# 시각화
# install.packages('corrgram')
library(corrgram)
corrgram(secondary11_1[ ,c(6,8,9:15) ],lower.panel = panel.conf)

```

- 인구 수와 다른 변수들의 상관계수가 비교적 높다고 판단하여 독립성을 위해 인구수 변수를 제거


#### 인구 수 뺀 모델의 다중공선성 확인

```{r}
fit11_3 <- lm(삶만족도 ~ class1 + 문화시설수 + 버스정거장수 + 지하철역수  + 아파트수 + 
                    체육시설수 + 범죄건수, data = secondary11_1)
summary(fit11_3)
sqrt(vif(fit11_3))

```

- 해당 모델의 모든 변수의 VIF가 2보다 작게 나온다.
- 인구 수를 제외하여 다중공선성(독립성)을 교정했음을 알 수 있다. 





### 3-2-4. 적당한 독립변수 선택

```{r}

library(leaps)
life <- secondary11_1[ ,c(2,6,8,9,10,12:15)]
aab<-regsubsets(`삶만족도`~ . , data = life)
aab1 <- summary(aab)

aab1
aab1$adjr2

```

```{r}
par(mfrow=c(1,1))
plot(aab, scale = "adjr2")

```


- 데이터의 갯수가 크지않으므로 모든 가능한 회귀(최량 부분 집합)를 사용하여 적당한 독립변수 탐색
- 탐색 결과, 독립변수가 'class1', '체육시설 수' 인 경우에서 가장 설명력이 높다.
- 탐색 결과, 독립변수가 '문화시설 수', 'class1', '지하철역 수'또한 높은 설명력을 보인다.
- 둘 중에 '문화시설 수', 'class1', '지하철역 수'의 경우가 더 타당해보이므로 채택(이거 근거 찾으면 더 좋아욥........)




```{r}
fit11_4 <- lm(삶만족도 ~ 문화시설수 + class1 + 지하철역수  , data=secondary11_1)
summary(fit11_4)

```
- 독립변수로 '문화시설 수', 'class1'을 갖는 모델의 설명력은 0.3304
- 설명력 0.1668 -> 0.3304 로 증가하여 모델의 성능이 향상됨( **+98.08%** ).
- 유의확률(p-value)이 0.016으로 유의한 모델이라고 보여진다. 


#### fit11_4 모델의 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부 확인

```{r}
par(mfrow=c(2,2))
plot(fit11_4)

```

- Residuals VS Fitted 그래프의 모양이 패턴이 없는 것으로 보아 선형성은 만족해보임
- Normal Q-Q 그래프의 경우 선에 점들이 모여있는 것으로 보아 정규성 만족해보임
- Scale-Location 그래프의 모양이 패턴이 없는 것으로 보아 등분산성 만족해보임





#### fit11_4 모델의 이상치의 여부 확인 및 교정

```{r}
# install.packages("car")
# library(car)

par(mfrow=c(1,1))
influencePlot(fit11_4, id=list(method = "identify")) 

```

- 이상치에 문제 없는 것으로 보임. 




























===========================================================================================
  
  
  
  
  
  
  
  
  
  
  




# 4. 지역 만족도에 대한 2차 회귀분석 



## 4-1. 종속변수가 삶의 만족도일 때, 1차 때 고른 독립변수 + 추가 독립변수

- 기존 'class1', '병원수'에 '버스정거장수','지하철역수', '인구수', '아파트수', '파출소수', '체육시설수', '범죄건수' 변수 추가

```{r}
fit22 <- lm(지역만족도 ~ class1 + 병원수 + 버스정거장수 + 지하철역수 + 인구수 + 아파트수 + 
                   체육시설수 + 범죄건수, data = secondary)    #학교수

summary(fit22)

```

- 설명력이 0.3074의 값이 나온다.
- 유의확률(p-value)이 0.07로 유의한 모델이라고 볼 수 없다.
- 이상치의 여부를 확인하여 교정할 것.
- 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부를 확인하여 교정할 것.




## 4-2. 종속변수가 지역 만족도일 때의 2차 단계적 성능 개선


## 4-2-1. 이상치의 여부 확인 및 교정

```{r}
# install.packages("car")
library(car)

par(mfrow=c(1,1))
influencePlot(fit22, id=list(method = "identify")) 

secondary22_1 <- secondary[-c(1, 3, 18, 24),]

str(secondary22_1)
```

- 1, 3, 18, 24 번째 데이터가 이상치임을 확인
- 해당 데이터를 삭제하여 교정


```{r}
fit22_2 <- lm(지역만족도 ~ class1 + 병원수 + 버스정거장수 + 인구수 + 지하철역수  + 아파트수 + 
                     체육시설수 + 범죄건수, data = secondary22_1)
summary(fit22_2)


```

- 이상치 제거 후, 설명력(Adjested R-squared) 0.59의 값 나옴
- 설명력 0.3074 -> 0.59 로 증가하여 모델의 성능이 향상됨( **+91.93%** ).
- 유의확률(P-value) 또한 0.008로 유의미한 모델이라고 볼 수 있다. 



## 4-2-2. 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부 확인 및 교정

```{r}
par(mfrow=c(2,2))
plot(fit22_2)


```

- Residuals VS Fitted 그래프의 모양이 패턴이 없는 것으로 보아 선형성은 만족해보임
- Normal Q-Q 그래프의 경우 선에 점들이 모여있는 것으로 보아 정규성 만족해보임
- Scale-Location 그래프의 모양이 패턴이 없는 것으로 보아 등분산성 만족해보임



### 3-2-3. 독립성(다중공선성) 여부 확인 및 교정

```{r}
# install.packages("car")
# library(car)
sqrt(vif(fit22_2))

```

- 병원 수와 인구 수의 VIF값이 2보다 커서 독립성에 문제가 있다고 보인다.


#### 상관계수 확인

```{r}
# 시각화
# install.packages('corrgram')
library(corrgram)
corrgram(secondary22_1[ ,c(4,8,9:15) ],lower.panel = panel.conf)

```

- 인구 수와 다른 변수들의 상관계수가 비교적 높다고 판단하여 독립성을 위해 인구수 변수를 제거
- 병원 수와 다른 변수들의 상관계수가 비교적 높다고 판단하여 독립성을 위해 병원수 변수를 제거


#### 인구 수, 병원 수 뺀 모델의 다중공선성 확인

```{r}
fit22_3 <- lm(지역만족도 ~ class1  + 버스정거장수 + 지하철역수  + 아파트수 + 
                     체육시설수 + 범죄건수, data = secondary22_1)
summary(fit22_3)
sqrt(vif(fit22_3))

```

- 해당 모델의 모든 변수의 VIF가 2보다 작게 나온다.
- 인구 수, 병원 수를 제외하여 다중공선성(독립성)을 교정했음을 알 수 있다. 





### 4-2-4. 적당한 독립변수 선택

```{r}

library(leaps)
region <- secondary22_1[ ,c(3,8:10,12:15)]
bba<-regsubsets(`지역만족도`~ . , data = region)
bba1 <- summary(bba)

bba1
bba1$adjr2

```

```{r}
par(mfrow=c(1,1))
plot(bba, scale = "adjr2")

```


- 데이터의 갯수가 크지않으므로 모든 가능한한 회귀(최량 부분 집합)를 사용하여 적당한 독립변수 탐색
- 탐색 결과, 독립변수가 'class1', '버스정거장 수', '범죄건수' 인 경우에서 가장 높은 설명력인 0.629의 값을 보인다.
- 탐색 결과, 독립변수가 'class1,, '버스정거장 수', '파출소 수', '체육시설 수', '범죄건수'인 경우에 0.622의 값을 보인다.
- 둘 중에 후자의 경우가 더 타당해보이므로(파출소 수, 체육시설 수 또한 지역만족도에 영향을 주는 요인으로 보여지므로) 채택(이거 근거 찾으면 더 좋아욥........)




```{r}
fit22_4 <- lm(지역만족도 ~  class1 + 버스정거장수 + 파출소수 + 체육시설수 + 범죄건수  , data=secondary22_1)
summary(fit22_4)

```
- 독립변수로 'class1,, '버스정거장 수', '파출소 수', '체육시설 수', '범죄건수'을 갖는 모델의 설명력은 0.6221
- 설명력 0.59 -> 0.6221 로 증가하여 모델의 성능이 향상됨( **+5.4%** ).
- 유의확률(p-value)이 0.0009로 유의한 모델이라고 보여진다. 


#### fit22_4 모델의 선형성 여부, 정규분포 여부, 등분산성 여부, 독립성 여부 확인

```{r}
par(mfrow=c(2,2))
plot(fit22_4)


```

- Residuals VS Fitted 그래프의 모양이 패턴이 없는 것으로 보아 선형성은 만족해보임
- Normal Q-Q 그래프의 경우 선에 점들이 모여있는 것으로 보아 정규성 만족해보임
- Scale-Location 그래프의 모양이 패턴이 없는 것으로 보아 등분산성 만족해보임





#### fit22_4 모델의 이상치의 여부 확인 및 교정

```{r}
# install.packages("car")
# library(car)

par(mfrow=c(1,1))
influencePlot(fit22_4, id=list(method = "identify")) 


secondary22_2 <- secondary22_1[-c(17,23),]

str(secondary22_2)
```

```{r}
fit22_5 <- lm(지역만족도 ~ class1 + 버스정거장수 + 파출소수 + 체육시설수 + 범죄건수   , data=secondary22_2)
summary(fit22_5)

```



- 독립변수로  'class1,, '버스정거장 수', '파출소 수', '체육시설 수', '범죄건수'를 갖는 모델(fit22_4)의 이상치를 제거 한 후의 설명력은 0.6583
- 설명력 0.6221 -> 0.6583 로 증가하여 모델의 성능이 향상됨( **+5.819%** ).
